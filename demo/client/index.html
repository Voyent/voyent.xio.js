<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Socket.io Messaging Client Test</title>
    <!--<script type="application/javascript" src="/push/socket.io.js"></script>-->
    <script src="https://cdn.socket.io/socket.io-1.3.7.js"></script>
    <script src="http://bridgeit.github.io/bridgeit.js/src/bridgeit.js"></script>
    <script src="http://bridgeit.github.io/bridgeit.io.js/lib/bridgeit.io.js"></script>
    <script src="http://bridgeit.github.io/bridgeit.xio.js/lib/bridgeit.xio.js"></script>
</head>
<body>

<h2>Socket.io Client Test</h2>

<form action="">

    <table>

        <tr>
            <td>Scheme:</td>
            <td>
                <select id="pushScheme" onchange="connect()">
                    <option value="http://">http://</option>
                    <option value="https://">https://</option>
                </select>
            </td>
        </tr>

        <tr>
            <td>Host:</td>
            <td>
                <select id="pushHost" onchange="connect()">
                    <option value="dev.bridgeit.io">dev.bridgeit.io</option>
                    <option value="192.168.99.100">192.168.99.100</option>
                    <option value="localhost:55140">localhost:55140</option>
                    <option value="192.168.99.100:55140">192.168.99.100:55140</option>
                </select>
            </td>
        </tr>

        <tr>
            <td>Account:</td>
            <td>
                <input type="text" id="account" autocomplete="off" value=""/>
            </td>
        </tr>

        <tr>
            <td>Realm:</td>
            <td>
                <input type="text" id="realm" autocomplete="off" value=""/>
            </td>
        </tr>

        <tr>
            <td>Username:</td>
            <td>
                <input type="text" id="username" autocomplete="off" value=""/>
            </td>
        </tr>

        <tr>
            <td>Password:</td>
            <td>
                <input type="password" id="password" autocomplete="off" value=""/>
                <button type="button" onclick="connect()">Connect</button>
                <button type="button" onclick="disconnect()">Disconnect</button>
            </td>
        </tr>

        <tr>
            <td></td>
            <td>
            </td>
        </tr>

        <tr>
            <td>Group:</td>
            <td>
                <input id="pushGroup" autocomplete="off" value="roomA"/>
                <button type="button" onclick="joinGroup()">Join</button>
                <button type="button" onclick="leaveGroup()">Leave</button>
            </td>
        </tr>

        <tr>
            <td></td>
            <td>
            </td>
        </tr>

        <tr>
            <td>Message:</td>
            <td>
                <input id="message" autocomplete="off"/>
                <button type="button" onclick="sendMessage()">Send</button>
            </td>
        </tr>

        <tr>
            <td></td>
            <td>
            </td>
        </tr>

        <tr>
            <td>Multi-Service:</td>
            <td>
                <button type="button" onclick="saveLocation()">Save Location</button>
            </td>
        </tr>

        <tr>
            <td></td>
            <td>
            </td>
        </tr>

    </table>

    <hr width="90%"/>
    <ul id="messages"></ul>

</form>

<script type="application/javascript">

    function getSelectedValue(selectId) {
        var selectItem = document.getElementById(selectId);
        return selectItem.options[selectItem.selectedIndex].value;
    }

    function getIdValue(id) {
        return document.getElementById(id).value;
    }

    function addMessage(message) {
        var messages = document.getElementById('messages');
        var entry = document.createElement('li');
        var messageNode = document.createTextNode(message);
        entry.appendChild(messageNode);
        messages.appendChild(entry);
    }

    function getPushScheme() {
        return getSelectedValue('pushScheme');
    }

    function getPushHost() {
        return getSelectedValue('pushHost');
    }

    function getPushNamespace() {
        return '/pushio/' + getIdValue('account') + '/realms/' + getIdValue('realm');
    }

    function getPushGroup() {
        return getIdValue('pushGroup');
    }

    function getPushURL() {
        return getPushScheme() + getPushHost() + getPushNamespace();
    }

    function connect() {
        bridgeit.io.configureHosts(getIdValue('pushHost'));
        bridgeit.xio.push.connect(getPushURL(), getIdValue('username'), getIdValue('password'));
    }

    function disconnect() {
        bridgeit.xio.push.disconnect();
    }

    function joinGroup() {
        var joinedAt = new Date().getTime();
        bridgeit.xio.push.join(getPushGroup(), function (payload) {
            var enhancedMessage = new Date().toISOString() + ' [' + payload.group + '] ' + ': ' + payload.message;
            console.log(joinedAt, enhancedMessage);
            addMessage(enhancedMessage);
        });
    }

    function leaveGroup() {
        bridgeit.xio.push.leave(getPushGroup());
    }

    function sendMessage() {
        bridgeit.xio.push.send(getPushGroup(), getIdValue('message'));
    }

    function getRandomInRange(from, to, fixed) {
        return (Math.random() * (to - from) + from).toFixed(fixed) * 1;
        // .toFixed() returns string, so ' * 1' is a trick to convert to number
    }

    function saveLocation() {

        var randomLong = getRandomInRange(-180, 180, 3);
        var randomLat = getRandomInRange(-90, 90, 3);

        var fakeLocation = {
            label: 'Socket.io Demo Client',
            location: {
                geometry: {
                    type: 'Point',
                    coordinates: [randomLong, randomLat]
                }
            }
        };

        console.log('sending fake location', fakeLocation);

        bridgeit.io.location.updateLocation(fakeLocation).then(function (uri) {
            console.log('location URI: ' + uri);
        }).catch(function (error) {
            console.log('could not update lcation: ' + error);
        });
    }

    //Turns on socket.io debugging in the browser console.
    //    localStorage.debug = '*';
    localStorage.debug = '';

    //    connect();

</script>

</body>
</html>